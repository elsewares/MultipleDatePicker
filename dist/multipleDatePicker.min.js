angular.module("multipleDatePicker",[]).factory("multipleDatePickerBroadcast",["$rootScope",function(a){var b={};return b.calendarId=null,b.message="",b.resetOrder=function(a){this.message="reset",this.calendarId=a,this.broadcastItem()},b.broadcastItem=function(){a.$broadcast("handleMultipleDatePickerBroadcast")},b.broadcastModifiedDate=function(b,c){a.$broadcast("multipleDatePickerModifiedDate",{oldDate:b,newDate:c})},b}]).directive("multipleDatePicker",["$log","multipleDatePickerBroadcast",function(a,b){"use strict";return{restrict:"AE",scope:{calendarId:"=?",dayClick:"=?",dayHover:"=?",month:"=?",monthChanged:"=?",daysSelected:"=?",weekDaysOff:"=?",highlightDays:"=?",bufferDays:"=?",originalDaysSelected:"=?",modifyOnly:"=?",allDaysOff:"=?",sundayFirstDay:"=?",disallowBackPastMonths:"=?",disallowGoFutureMonths:"=?",showDaysOfSurroundingMonths:"=?",cssDaysOfSurroundingMonths:"=?",calendarRange:"=?",fireEventsForDaysOfSurroundingMonths:"=?",disableDaysBefore:"=?",disableDaysAfter:"=?"},template:'<div class="multiple-date-picker"><div class="picker-top-row"><div class="text-center picker-navigate picker-navigate-left-arrow" ng-class="{\'disabled\':disableBackButton}" ng-click="previousMonth()">&lt;</div><div class="text-center picker-month" ng-if="!calendarSelect">{{month.format(\'MMMM YYYY\')}}</div><div class="text-center picker-month" ng-if="calendarSelect"><select ng-options="mo.value as mo.label for mo in scope.calendarRange" ng-model="month"></select></div><div class="text-center picker-navigate picker-navigate-right-arrow" ng-class="{\'disabled\':disableNextButton}" ng-click="nextMonth()">&gt;</div></div><div class="picker-days-week-row"><div class="text-center" ng-repeat="day in daysOfWeek">{{day}}</div></div><div class="picker-days-row"><div class="text-center picker-day {{!day.otherMonth || showDaysOfSurroundingMonths ? day.css : \'\'}} {{day.otherMonth ? cssDaysOfSurroundingMonths : \'\'}}" title="{{day.title}}" ng-repeat="day in days" ng-click="toggleDay($event, day)" ng-mouseover="hoverDay($event, day)" ng-mouseleave="dayHover($event, day)" '+"ng-class=\"{'picker-selected':day.selected, 'picker-off':!day.selectable, 'today':day.today,'past':day.past,'future':day.future, 'picker-other-month':day.otherMonth, 'buffer-day':day.bufferDay.length && showBufferDays(day) }\">{{day ? day.otherMonth && !showDaysOfSurroundingMonths ? '&nbsp;' : day.format('D') : ''}}</div></div></div>",link:function(a){var c=function(){var b=moment(),c=moment(a.month).subtract(1,"month"),d=moment(a.month).add(1,"month");a.disableBackButton=a.disallowBackPastMonths&&b.isAfter(c,"month")||f("start"),a.disableNextButton=a.disallowGoFutureMonths&&b.isBefore(d,"month")||f("end")},d=function(){for(var b=moment().localeData()._weekdaysMin,c=[],d=1;7>d;d++)c.push(b[d]);return a.sundayFirstDay?c.splice(0,0,b[0]):c.push(b[0]),c},e=function(){var b=a.daysSelected||[],c=a.originalDaysSelected||[],d=[],e=[];b.map(function(a){e.push(moment(a))}),c.map(function(a){d.push(moment(a))}),a.convertedDaysSelected=e,a.convertedOriginalDaysSelected=d,a.generate()},f=function(b){if(a.calendarRange&&a.calendarRange.length>1){var c="start"===b?a.calendarRange[0].value:a.calendarRange[a.calendarRange.length-1].value;return a.month.format("MMMM YYYY")===c.format("MMMM YYYY")}return!1};a.init=function(){a.calendarRange&&a.calendarRange.length>0?(a.month=a.calendarRange[0].value,a.disableBackButton=!0):a.month=moment(moment().format("MMMM YYYY")),a.generate()},a.$on("handleMultipleDatePickerBroadcast",function(){"reset"!==b.message||b.calendarId&&b.calendarId!==a.calendarId||e()}),a.$watch("daysSelected",function(a){a&&e()},!0),a.$watch("weekDaysOff",function(){a.generate()},!0),a.$watch("highlightDays",function(){a.generate()},!0),a.$watch("allDaysOff",function(){a.generate()},!0);var g=null;a.month=a.month||moment().startOf("day"),a.days=[],a.convertedDaysSelected=a.convertedDaysSelected||[],a.weekDaysOff=a.weekDaysOff||[],a.daysOff=a.daysOff||[],a.disableBackButton=!1,a.disableNextButton=!1,a.daysOfWeek=d(),a.cssDaysOfSurroundingMonths=a.cssDaysOfSurroundingMonths||"picker-empty",a.modifyOnly=a.modifyOnly||!1,a.bufferDays=a.bufferDays||0,a.calendarRange=a.calendarRange||!1,a.toggleDay=function(c,d){if(c.preventDefault(),!d.otherMonth||a.fireEventsForDaysOfSurroundingMonths){var e=!1;return c.preventDefault=function(){e=!0},a.modifyOnly?d.selected||d.bufferDay?d.selected?(g=d,console.log("Date to modify selected."),void console.log(g)):d.bufferDay&&g._isAMomentObject?(b.broadcastModifiedDate(g,d),g=null,console.log("Buffer day selected."),console.log("Modify date: "),void console.log([g,d])):void console.log("Do nothing - no day selected for buffer day."):(g=null,void console.log("Any old day. No nothing. Reset buffers.")):("function"==typeof a.dayClick&&a.dayClick(c,d),void(d.selectable&&!e&&(d.selected=!d.selected,d.selected?a.convertedDaysSelected.push(d):a.convertedDaysSelected=a.convertedDaysSelected.filter(function(a){return a.valueOf()!==d.valueOf()}))))}},a.hoverDay=function(b,c){b.preventDefault();var d=!1;b.preventDefault=function(){d=!0},"function"==typeof a.dayHover&&a.dayHover(b,c),d||(c.hover="mouseover"===b.type)},a.previousMonth=function(){if(!a.disableBackButton){var b=moment(a.month);a.month=a.month.subtract(1,"month"),"function"==typeof a.monthChanged&&a.monthChanged(a.month,b),a.generate()}},a.nextMonth=function(){if(!a.disableNextButton){var b=moment(a.month);a.month=a.month.add(1,"month"),"function"==typeof a.monthChanged&&a.monthChanged(a.month,b),a.generate()}},a.isDayOff=function(a,b){return a.allDaysOff||!!a.disableDaysBefore&&moment(b).isBefore(a.disableDaysBefore,"day")||!!a.disableDaysAfter&&moment(b).isAfter(a.disableDaysAfter,"day")||angular.isArray(a.weekDaysOff)&&a.weekDaysOff.some(function(a){return b.day()===a})||angular.isArray(a.daysOff)&&a.daysOff.some(function(a){return b.isSame(a,"day")})||angular.isArray(a.highlightDays)&&a.highlightDays.some(function(a){return b.isSame(a.date,"day")&&!a.selectable})},a.isSelected=function(a,b){return a.convertedDaysSelected.some(function(a){return b.isSame(a,"day")})},a.isBufferDay=function(a,b){var c=[];return angular.forEach(a.convertedOriginalDaysSelected,function(d){var e,f=moment(d).subtract(a.bufferDays,"days"),g=moment(d).add(a.bufferDays,"days");e=moment(b).isBetween(f,g),e&&c.push(d.format("YYYY-MM-DD"))}),c},a.showBufferDays=function(a){var b=[];return g&&a.bufferDay.length>0&&angular.forEach(a.bufferDay,function(a){b.push(g.format("YYYY-MM-DD")===a.format("YYYY-MM-DD"))}),b.some(function(a){return a===!0})},a.generate=function(){var b=moment(a.month).date(0).day(a.sundayFirstDay?0:1).subtract(1,"day");moment(a.month).date(0).diff(b,"day")>6&&(b=b.add(1,"week"));var d=moment(a.month).date(1),e=[],f=moment(),g=moment(d).endOf("month"),h=function(){var c=moment(b.add(1,"day"));if(angular.isArray(a.highlightDays)){var d=a.highlightDays.filter(function(a){return c.isSame(a.date,"day")});c.css=d.length>0?d[0].css:"",c.title=d.length>0?d[0].title:""}return c.selectable=!a.isDayOff(a,c),c.selected=a.isSelected(a,c),c.bufferDay=!c.selected&&c.selectable?a.isBufferDay(a,c):!1,c.today=c.isSame(f,"day"),c.past=c.isBefore(f,"day"),c.future=c.isAfter(f,"day"),c.isSame(a.month,"month")||(c.otherMonth=!0),c},i=g.diff(b,"days"),j=a.sundayFirstDay?6:0;g.day()!==j&&(i+=(a.sundayFirstDay?6:7)-g.day());for(var k=0;i>k;k++)e.push(h());a.days=e,c(),console.log(a)},a.init()}}}]);